---
title: "SOSH GAMLSS"
author: "Max Czapanskiy"
date: "July 22, 2016"
output: html_document
---

```{r set-options, echo = FALSE, cache = FALSE}
options(width = 120)
```

Goal: demonstrate improved quality of seabird distribution models by incorporating individual tracking data
Method: Locations from tracked sooty shearwaters have been aggregated into kernel density estimates. These utilization distributions will be used in conjunction with more commonly used variables to create distribution models. The model of choice is GAMLSS, for its ability to handle non-linear relationships and errors.

1. Load packages
```{r load_packages, message = FALSE, warning = FALSE}
library(gamlss)
library(dplyr)
library(foreach)
library(doParallel)
```

2. Load data
```{r load_data}
sosh.data <- read.csv('TelemetryTransect17May2016_SOSH-PFSH-COMU.csv') %>% 
  dplyr::select(SOSHcount, Binarea, Month, 
                Latitude, DistCoast, Dist200, DepCI,
                SSTmean, STD_SST, MEAN_Beaufort, L10CHLproxy, STD_CHL_log10, Watermass,
                L10CHLsurvey, CHLsurvanom, L10CHLsurvclim, FCPI) %>%
  filter(Month > 2) %>% # exclude tiny January, February surveys
  mutate(SOSHcount = as.integer(SOSHcount),
         Month = factor(Month)) %>%
  na.omit
head(sosh.data)
summary(sosh.data)
```

3. Set up parallel processing
```{r register_parallel}
nCores <- detectCores()
gamlssCl <- makeCluster(nCores)
registerDoParallel(gamlssCl)
```

4. Create geographic and oceanographic models by month using canonical discrete distributions WITHOUT home range variable:
```{r fit_models, cache = TRUE}
# Wrapper for gamlss. Error handling and refitting.
N_REFIT <- 5
try.fit <- function(formula, data, family, n_refit = N_REFIT) {
  # Try to fit model
  model <- try(gamlss(formula, data = data, family = family))
  fitAttempts <- 1
  
  # Keep refitting model until...
  while(fitAttempts <= n_refit &&             # ... we run out of attempts,
        class(model) != 'try-error' &&        # get an error,
        !getElement(model, 'converged')) {    # or model converges
    model <- try(refit(model))
    fitAttempts <- fitAttempts + 1
  }
  # Return fitting results. Hopefully it's a fitted model, may be a try-error
  model
}

# Create models using canonical discrete distributions.
# SOSHcount as function of FCPI, Dist200, SSTmean (all three cubic splines) with Month as random variable 
# and log(Binarea) as offset
# Create models using canonical discrete distributions for each month.
# Geographic + oceanographic models
# geo = SOSHcount ~  cs(Latitude)+cs(DistCoast)+cs(Dist200)+cs(DepCI) + offset(log(Binarea))
# ocean = SOSHcount ~ cs(SSTmean)+cs(STD_SST)+cs(MEAN_Beaufort)+cs(L10CHLproxy)+cs(STD_CHL_log10)+Watermass+cs(L10CHLsurvey)+
#   cs(CHLsurvanom)+cs(L10CHLsurvclim)+cs(FCPI) + offset(log(Binarea))
discrete.dist <- c('PO', 'NBI', 'NBII', 'DEL', 'PIG', 'SI', 'SICHEL', 'ZIP', 'ZIP2')
months <- c(6, 7, 9, 10)
# For each discrete distribution...
monthly.geo.ocean.models <- foreach(dist = discrete.dist,
                                    .packages = c('foreach',
                                                  'doParallel',
                                                  'gamlss',
                                                  'dplyr')) %dopar% {
  # For each month's survey...
  foreach(month = months) %dopar% {
    print(sprintf('Distribution %s, month %i', dist, month))
    
    # Filter SOSH data to the month of interest
    month.data <- filter(sosh.data, Month == month)
    if(nrow(month.data) == 0) stop(sprintf('No data in month %i', month))
    
    # Fit geographic model
    print('Fitting geographic model')
    geo.model <- try.fit(SOSHcount ~ cs(Latitude) + cs(DistCoast) + cs(Dist200) + cs(DepCI) + offset(log(Binarea)),
                         data = month.data,
                         family = get('dist'))
    
    # Fit oceanographic model
    print('Fitting oceanographic model')
    ocean.model <- try.fit(SOSHcount ~ cs(SSTmean) + cs(STD_SST) + cs(MEAN_Beaufort) + cs(L10CHLproxy) + 
                                cs(STD_CHL_log10) + as.factor(Watermass) + cs(L10CHLsurvey) + cs(CHLsurvanom) + 
                                cs(L10CHLsurvclim) + cs(FCPI) + offset(log(Binarea)),
                           data = month.data,
                           family = get('dist'))
    
    list(dist = dist,
         month = month,
         geo.model = geo.model,
         ocean.model = ocean.model)
  }
}

stopCluster(gamlssCl)
```

5. Summarize model results for ranking (parameters, convergence, EDF, AIC)
```{r summarize_models}
model.rankings <- foreach(dist.list = monthly.geo.ocean.models, .combine = rbind) %do% {
  foreach(models = dist.list, .combine = rbind) %do% {
    data.frame(Distribution = models$dist,
               Month = models$month,
               GeoConverged = tryCatch(getElement(models$geo.model, 'converged'), error = function(e) NA),
               GeoEDF = tryCatch(extractAIC(models$geo.model)[1], error = function(e) NA),
               GeoAIC = tryCatch(extractAIC(models$geo.model)[2], error = function(e) NA),
               OceanConverged = tryCatch(getElement(models$ocean.model, 'converged'), error = function(e) NA),
               OceanEDF = tryCatch(extractAIC(models$ocean.model)[1], error = function(e) NA),
               OceanAIC = tryCatch(extractAIC(models$ocean.model)[2], error = function(e) NA))
  }
}
model.rankings
```

6. SI, SICHEL, and PIG distributions tend to perform the best (which makes sense, they're all closely related). DEL Shows up in there, too, but for the most part negative binomial models didn't cut it. The geographic models outperform their oceanographic counterparts in every month but June. However, is that due to their relative parsimony? Geographic models use 4 predictor variables and oceanographic models use 10.
```{r best_fits}
model.rankings %>%
  filter(GeoConverged) %>%
  group_by(Month) %>%
  arrange(GeoAIC) %>% 
  slice(1:4)
model.rankings %>%
  filter(OceanConverged) %>%
  group_by(Month) %>%
  arrange(OceanAIC) %>% 
  slice(1:4)
```
